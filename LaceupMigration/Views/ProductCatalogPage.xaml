<?xml version="1.0" encoding="utf-8" ?>
<local:LaceupContentPage xmlns:local="clr-namespace:LaceupMigration.Views" xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaceupMigration.ViewModels"
             xmlns:lm="clr-namespace:LaceupMigration"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             xmlns:laceupMigration="clr-namespace:LaceupMigration;assembly=LaceupMigration.Business"
             x:Class="LaceupMigration.Views.ProductCatalogPage"
             x:DataType="vm:ProductCatalogPageViewModel"
             Shell.NavBarIsVisible="True"
             Shell.TabBarIsVisible="False"
             Title="{Binding PageTitle}">
    <ContentPage.Content>
        <Grid RowDefinitions="Auto,*">
            <!-- Search Bar with Barcode Icon -->
            <Frame Grid.Row="0" Margin="8,4" Padding="0" HasShadow="False" BorderColor="{StaticResource Gray300}" BackgroundColor="{StaticResource White}">
                <Grid ColumnDefinitions="*,Auto" Padding="0,0,5,0">
                    <SearchBar Grid.Column="0"
                               Text="{Binding SearchQuery}"
                               Placeholder="Search products..."
                               BackgroundColor="White"
                               Margin="0" />
                    <ImageButton Grid.Column="1"
                                 Source="{mi:MaterialOutlined Icon=QrCodeScanner, IconColor=Black}"
                                 WidthRequest="40"
                                 HeightRequest="40"
                                 BackgroundColor="Transparent"
                                 Command="{Binding ScanCommand}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center" />
                </Grid>
            </Frame>

            <!-- Product List: main line with + only, sublines (order details) below per product -->
            <CollectionView x:Name="ProductsCollectionView"
                            Grid.Row="1"
                            ItemsSource="{Binding FilteredProducts}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:CatalogItemViewModel">
                        <Grid Style="{StaticResource CollectionViewItemStyle}">
                            <Frame Padding="12" Margin="8,2" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}">
                                <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                                    <!-- Main line: product name, OH, list price, total, + button only (for adding) -->
                                    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                        <Image Source="{Binding ProductImg}"
                                               WidthRequest="60"
                                               HeightRequest="60"
                                               Grid.Column="0"
                                               IsVisible="{Binding HasImage}">
                                            <Image.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProductCatalogPageViewModel}}, Path=ViewImageCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Image.GestureRecognizers>
                                        </Image>
                                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                            <VerticalStackLayout.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProductCatalogPageViewModel}}, Path=ViewProductDetailsCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </VerticalStackLayout.GestureRecognizers>
                                            <Label Text="{Binding ProductName}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding ProductNameColor}" />
                                            <Label Text="{Binding OnHandText}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource Gray600}" />
                                            <Label Text="{Binding ListPriceText}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource Gray600}" />
                                            <Label Text="{Binding TotalText}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource PrimaryDark}"
                                                   IsVisible="{Binding HasValues}" />
                                            <Label Text="{Binding SuggestedLabelText}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource colorLaceupGreen}"
                                                   IsVisible="{Binding IsSuggested}"
                                                   Margin="0,2,0,0" />
                                        </VerticalStackLayout>
                                        <!-- Plus button: add via RestOfTheAddDialog -->
                                        <Button Grid.Column="2"
                                                Text="{Binding QuantityButtonText}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProductCatalogPageViewModel}}, Path=AddButtonClickCommand}"
                                                CommandParameter="{Binding .}"
                                                WidthRequest="70"
                                                HeightRequest="36"
                                                Style="{StaticResource PrimaryButton}"
                                                FontSize="18"
                                                FontAttributes="Bold"
                                                CornerRadius="5"
                                                VerticalOptions="Center"
                                                HorizontalOptions="End" />
                                    </Grid>
                                    <!-- Sublines: each order detail (same product, different UoM/price/type) - tap to edit -->
                                    <CollectionView Grid.Row="1"
                                                    ItemsSource="{Binding Values}"
                                                    SelectionMode="None"
                                                    IsVisible="{Binding HasValues}"
                                                    Margin="0,4,0,0">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="laceupMigration:OdLine">
                                                <Frame Padding="8,6" Margin="0,2" HasShadow="False" BorderColor="{StaticResource Gray200}" BackgroundColor="{StaticResource Gray50}">
                                                    <Frame.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProductCatalogPageViewModel}}, Path=EditSublineCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Frame.GestureRecognizers>
                                                    <Grid ColumnDefinitions="*,*,*,*,*" ColumnSpacing="5">
                                                        <Label Grid.Column="0" FontSize="17" FontAttributes="Bold" TextColor="Orange" VerticalOptions="Center" IsVisible="{Binding IsCredit}">
                                                            <Label.Text>
                                                                <Binding Path="Damaged" Converter="{StaticResource CreditTypeConverter}" />
                                                            </Label.Text>
                                                        </Label>
                                                        <Label Grid.Column="1" FontSize="15" FontAttributes="Bold" TextColor="{Binding OHColor}" Text="{Binding OH}" VerticalOptions="Center"></Label>
                                                        <Label Grid.Column="2" FontSize="17" HorizontalOptions="End" HorizontalTextAlignment="End" FontAttributes="Bold" TextColor="{StaticResource PrimaryDark}" VerticalOptions="Center">
                                                            <Label.Text>
                                                                <Binding Path="Qty" StringFormat="{}Qty: {0:F0}" />
                                                            </Label.Text>
                                                        </Label>
                                                        <Label Grid.Column="3" FontSize="17" HorizontalOptions="Start" HorizontalTextAlignment="Start" FontAttributes="Bold" TextColor="{StaticResource Gray700}" VerticalOptions="Center">
                                                            <Label.Text>
                                                                <Binding Path="UoM.Name" TargetNullValue="" />
                                                            </Label.Text>
                                                        </Label>
                                                        <Label Grid.Column="4" FontSize="17" FontAttributes="Bold" HorizontalOptions="End" HorizontalTextAlignment="End" TextColor="{StaticResource Gray700}" VerticalOptions="Center">
                                                            <Label.Text>
                                                                <Binding Path="Price" StringFormat="{}{0:C2}" />
                                                            </Label.Text>
                                                        </Label>

                                                    </Grid>
                                                </Frame>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <Label Text="No products found."
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,50,0,0" />
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>
    </ContentPage.Content>
</local:LaceupContentPage>

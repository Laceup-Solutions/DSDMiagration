<?xml version="1.0" encoding="utf-8" ?>
<local:LaceupContentPage xmlns:local="clr-namespace:LaceupMigration.Views"
             x:Class="LaceupMigration.Views.SelfService.SelfServiceCategoriesPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaceupMigration.ViewModels.SelfService"
             xmlns:fullvm="clr-namespace:LaceupMigration.ViewModels"
             xmlns:business="clr-namespace:LaceupMigration;assembly=LaceupMigration.Business"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:DataType="vm:SelfServiceCategoriesPageViewModel"
             Shell.NavBarIsVisible="True"
             Shell.TabBarIsVisible="False"
             Title="{Binding Title}">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="" Order="Primary" Priority="0" IconImageSource="{mi:MaterialOutlined Icon=HelpOutline, IconColor=Black}" Command="{Binding ShowToolbarMenuCommand}" />
        <ToolbarItem Text="" Order="Primary" Priority="1" IconImageSource="{mi:MaterialOutlined Icon=ShoppingCart, IconColor=Black}" Command="{Binding PopCommand}" />
    </ContentPage.ToolbarItems>
    <ContentPage.Content>
        <Grid RowDefinitions="Auto,Auto,Auto,*" Padding="5">
            <!-- Client name (SelfService only) -->
            <Label Grid.Row="0"
                   Text="{Binding ClientName}"
                   FontSize="18"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   Margin="0,10,0,0"/>

            <!-- Search Bar with Barcode Icon (matches FullCategoryPage) -->
            <Frame Grid.Row="1" Margin="5,10,5,0" Padding="0" HasShadow="False" BorderColor="{StaticResource Gray300}" BackgroundColor="{StaticResource White}">
                <Grid ColumnDefinitions="*,Auto" Padding="0,0,5,0">
                    <SearchBar Grid.Column="0"
                               Text="{Binding SearchQuery, Mode=TwoWay}"
                               Placeholder="Search categories or products..."
                               TextChanged="SearchBar_TextChanged"
                               SearchButtonPressed="SearchBar_SearchButtonPressed"
                               BackgroundColor="White"
                               Margin="0" />
                    <ImageButton Grid.Column="1"
                                 Source="{mi:MaterialOutlined Icon=QrCodeScanner, IconColor=Black}"
                                 WidthRequest="40"
                                 HeightRequest="40"
                                 BackgroundColor="Transparent"
                                 Command="{Binding ScanCommand}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center" />
                </Grid>
            </Frame>

            <!-- Radio Buttons (horizontal) - Only show when displaying categories -->
            <HorizontalStackLayout Grid.Row="2"
                                   Spacing="16"
                                   HorizontalOptions="Center"
                                   Margin="0,8,0,0"
                                   IsVisible="{Binding ShowCategories}">
                <RadioButton Content="By Category"
                             IsChecked="{Binding SearchByCategory}"
                             GroupName="SearchType" />
                <RadioButton Content="By Product"
                             IsChecked="{Binding SearchByProduct}"
                             GroupName="SearchType" />
            </HorizontalStackLayout>

            <!-- Categories ListView (matches FullCategoryPage - expandable subcategories) -->
            <CollectionView x:Name="CategoriesCollectionView"
                            Grid.Row="3"
                            ItemsSource="{Binding Categories}"
                            SelectionMode="None"
                            Margin="0,20,0,0"
                            IsVisible="{Binding ShowCategories}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="fullvm:CategoryViewModel">
                        <Frame Padding="0" Margin="8,4" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}" BorderColor="{StaticResource Gray200}">
                            <Grid RowDefinitions="Auto,Auto" Padding="12">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="Category_Tapped" />
                                </Grid.GestureRecognizers>
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding Name}"
                                           FontSize="16"
                                           TextColor="{StaticResource Gray900}"
                                           VerticalOptions="Center" />
                                    <Image Grid.Column="1"
                                           Source="{mi:MaterialOutlined Icon=ExpandMore, IconColor=Gray}"
                                           WidthRequest="24"
                                           HeightRequest="24"
                                           IsVisible="{Binding ShowSubcategories}"
                                           VerticalOptions="Center" />
                                </Grid>
                                <!-- Subcategories (expandable) -->
                                <VerticalStackLayout Grid.Row="1"
                                                     IsVisible="{Binding IsExpanded}"
                                                     Margin="20,8,0,0"
                                                     Spacing="0">
                                    <CollectionView ItemsSource="{Binding Subcategories}"
                                                    SelectionMode="Single"
                                                    SelectionChanged="Subcategory_SelectionChanged">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="business:Category">
                                                <Grid RowDefinitions="Auto,Auto">
                                                    <Frame Grid.Row="0" Padding="0" Margin="0" HasShadow="False" CornerRadius="0" BackgroundColor="{StaticResource White}" BorderColor="Transparent">
                                                        <Frame.GestureRecognizers>
                                                            <TapGestureRecognizer Tapped="Subcategory_Tapped" />
                                                        </Frame.GestureRecognizers>
                                                        <Grid ColumnDefinitions="*,Auto" Padding="12,10" ColumnSpacing="8">
                                                            <Label Grid.Column="0"
                                                                   Text="{Binding Name}"
                                                                   FontSize="15"
                                                                   TextColor="{StaticResource Gray900}"
                                                                   VerticalOptions="Center" />
                                                            <Image Grid.Column="1"
                                                                   Source="{mi:MaterialOutlined Icon=ChevronRight, IconColor=Gray}"
                                                                   WidthRequest="20"
                                                                   HeightRequest="20"
                                                                   VerticalOptions="Center"
                                                                   HorizontalOptions="End" />
                                                        </Grid>
                                                    </Frame>
                                                    <BoxView Grid.Row="1"
                                                             HeightRequest="1"
                                                             Color="{StaticResource Gray300}"
                                                             Margin="12,0,0,0" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Products ListView (matches FullCategoryPage) -->
            <CollectionView x:Name="ProductsCollectionView"
                            Grid.Row="3"
                            ItemsSource="{Binding Products}"
                            SelectionMode="Single"
                            Margin="0,20,0,0"
                            IsVisible="{Binding ShowProducts}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="fullvm:ProductViewModel">
                        <Grid Style="{StaticResource CollectionViewItemStyle}">
                            <Frame Padding="0" Margin="2,4" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}" BorderColor="{StaticResource Gray200}">
                                <Grid Padding="5,12,5,12">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="ProductCell_Tapped" />
                                    </Grid.GestureRecognizers>
                                    <VerticalStackLayout Spacing="8">
                                        <Image Source="{Binding ProductImagePath}"
                                               HeightRequest="300"
                                               MinimumHeightRequest="300"
                                               Aspect="AspectFit"
                                               HorizontalOptions="Fill"
                                               VerticalOptions="Start"
                                               Margin="0,20,0,20"
                                               IsVisible="{Binding HasImage}">
                                            <Image.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="ProductImage_Tapped" />
                                            </Image.GestureRecognizers>
                                        </Image>
                                        <Label Text="{Binding Name}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Gray900}"
                                               HorizontalOptions="Start"
                                               Margin="0,4,0,0" />
                                        <Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="4" RowSpacing="4">
                                            <Label Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="2"
                                                   Text="{Binding Upc, StringFormat='UPC: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   HorizontalOptions="Start"/>
                                            <Label Grid.Column="2" Grid.Row="0"
                                                   Text="{Binding Packaging, StringFormat='Packaging: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="0" Grid.Row="1"
                                                   Text="{Binding OnHandText, StringFormat='OH: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="1" Grid.Row="1"
                                                   Text="{Binding Uom, StringFormat='UoM: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   IsVisible="{Binding ShowUom}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="2" Grid.Row="1"
                                                   Text="{Binding Price, StringFormat='Price: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   IsVisible="{Binding ShowPrice}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="0" Grid.Row="2" Text="{Binding OnHand1, StringFormat='OH: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   IsVisible="{Binding ShowOnHand1}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="1" Grid.Row="2"  Text="{Binding Uom1, StringFormat='UoM: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   IsVisible="{Binding ShowUom1}"
                                                   HorizontalOptions="Start" />
                                            <Label Grid.Column="2" Grid.Row="2"  Text="{Binding Price1, StringFormat='Price: {0}'}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource colorLaceupDark}"
                                                   IsVisible="{Binding ShowPrice1}"
                                                   HorizontalOptions="Start" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Grid.Row="3"
                   Text="No items found."
                   IsVisible="{Binding ShowNoCategories}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Margin="0,20,0,20"
                   TextColor="{StaticResource Gray500}" />
        </Grid>
    </ContentPage.Content>
</local:LaceupContentPage>

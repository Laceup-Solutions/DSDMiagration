<?xml version="1.0" encoding="utf-8" ?>
<local:LaceupContentPage xmlns:local="clr-namespace:LaceupMigration.Views" xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaceupMigration.ViewModels"
             x:Class="LaceupMigration.Views.PreviouslyOrderedTemplatePage"
             x:DataType="vm:PreviouslyOrderedTemplatePageViewModel"
             Shell.NavBarIsVisible="True"
             Shell.TabBarIsVisible="False"
             Title="{Binding OrderTypeText}">
    <ContentPage.Content>
        <Grid RowDefinitions="Auto,Auto,Auto,*">
            <!-- Action Buttons -->
            <Grid x:Name="ActionButtonsGrid" Grid.Row="0" ColumnSpacing="4" Padding="8,8,8,4">
                <Button Text="Add Credit"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding AddCreditCommand}"
                        IsEnabled="{Binding CanEdit}"
                        IsVisible="{Binding ShowAddCredit}"
                        Grid.Column="0" />
                <Button x:Name="ProdButton" Text="Prod"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding ViewProductsCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="1" />
                <Button x:Name="CatsButton" Text="Cats"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding ViewCategoriesCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="2" />
                <Button x:Name="SearchButton" Text="Search"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SearchCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="3" />
                <Button x:Name="SendButton" Text="{Binding SendOrDoneButtonText}"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SendOrDoneCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="4" />
            </Grid>

            <!-- Customer and Order Summary (Collapsible, expanded by default) -->
            <Frame Grid.Row="1" Padding="5" Margin="8,2" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}">
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="6" RowSpacing="4">
                    <!-- Collapsed View: Client Name and Total -->
                    <Label Grid.Row="0" Grid.Column="0"
                           Text="{Binding ClientName}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{StaticResource PrimaryDark}"
                           VerticalOptions="Center"
                           LineBreakMode="TailTruncation" />
                    <Label Grid.Row="0" Grid.Column="1"
                           Text="{Binding TotalText}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{StaticResource PrimaryDark}"
                           HorizontalOptions="End"
                           VerticalOptions="Center"
                           IsVisible="{Binding ShowTotalInHeader}" />
                    <!-- Expand/Collapse Indicator -->
                    <Grid Grid.Row="0" Grid.Column="2"
                          HorizontalOptions="End"
                          VerticalOptions="Center"
                          WidthRequest="24"
                          HeightRequest="24">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleOrderSummaryCommand}" />
                        </Grid.GestureRecognizers>
                        <Label Text="{Binding IsOrderSummaryExpanded, Converter={StaticResource ExpandIconConverter}}"
                               FontSize="14"
                               TextColor="{StaticResource Gray600}"
                               VerticalOptions="Center"
                               HorizontalOptions="Center" />
                    </Grid>
                    <!-- Expanded Content -->
                    <Grid Grid.Row="1" Grid.ColumnSpan="3"
                          RowDefinitions="Auto,Auto,Auto"
                          ColumnDefinitions="*,*,*"
                          ColumnSpacing="3"
                          RowSpacing="4"
                          Margin="0,4,0,0"
                          IsVisible="{Binding IsOrderSummaryExpanded}">
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Grid.ColumnSpan="3">
                            <Label Grid.Column="0"
                                   Text="{Binding CompanyText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray600}"
                                   IsVisible="{Binding ShowCompany}"
                                   Margin="0,0,0,0" />
                            <Label Grid.Column="1"
                                   Text="{Binding TermsText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   IsVisible="{Binding TermsVisible}"
                                   TextColor="{StaticResource Gray600}"
                                   Margin="0,0,0,0" />
                        </Grid>
                        <!-- OneDoc layout: show Order: and Credit: (3 columns: Lines/QtySold | Order/Credit/Subtotal | Tax/Discount/Total) -->
                        <Grid Grid.Row="1" Grid.ColumnSpan="3" ColumnDefinitions="*,*,*" ColumnSpacing="3" RowSpacing="4" IsVisible="{Binding ShowOneDocTotalsLayout}">
                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                <Label Text="{Binding LinesText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                                <Label Text="{Binding QtySoldText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                <Label Text="{Binding OrderAmountText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowTotals}" />
                                <Label Text="{Binding CreditAmountText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowTotals}" />
                                <Label Text="{Binding SubtotalText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowTotals}" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="2" Spacing="2">
                                <Label Text="{Binding TaxText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowTotals}" />
                                <Label Text="{Binding DiscountText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowDiscount}" />
                                <Label Text="{Binding TotalText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource PrimaryDark}" IsVisible="{Binding ShowTotals}" />
                            </VerticalStackLayout>
                        </Grid>
                        <!-- Two-row layout when OneDoc is off: Row1 Lines|Subtotal|Tax, Row2 Qty Sold|Discount|Total -->
                        <Grid Grid.Row="1" Grid.ColumnSpan="3" ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto" ColumnSpacing="3" RowSpacing="4" IsVisible="{Binding UseSimpleTotalsLayout}">
                            <Label Grid.Row="0" Grid.Column="0" Text="{Binding LinesText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding SubtotalText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Grid.Row="0" Grid.Column="2" Text="{Binding TaxText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Grid.Row="1" Grid.Column="0" Text="{Binding QtySoldText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding DiscountText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray900}" IsVisible="{Binding ShowDiscount}" />
                            <Label Grid.Row="1" Grid.Column="2" Text="{Binding TotalText}" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource PrimaryDark}" />
                        </Grid>
                    </Grid>
                </Grid>
            </Frame>

            <!-- Sort By -->
            <Grid Grid.Row="2" Padding="8,2,16,2">
                <Label Text="{Binding SortByText}"
                       FontSize="14"
                       TextColor="{StaticResource PrimaryDark}"
                       HorizontalOptions="End"
                       VerticalOptions="Center">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortByCommand}" />
                    </Label.GestureRecognizers>
                </Label>
            </Grid>

            <!-- Previously Ordered Products List -->
            <CollectionView Grid.Row="3"
                            ItemsSource="{Binding PreviouslyOrderedProducts}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:PreviouslyOrderedProductViewModel">
                        <Frame Padding="10" Margin="8,2" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCellTapped" />
                            </Frame.GestureRecognizers>
                            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="2">
                                <!-- Product Name and OH -->
                                <Label Grid.Column="0" Grid.Row="0"
                                       Text="{Binding ProductName}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="{Binding ProductNameColor}" />
                                
                                <Grid Grid.Row="1" ColumnDefinitions="*,auto">
                                    <Label Grid.Column="0" Text="{Binding UomDisplayText}"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           TextColor="Black"
                                           IsVisible="{Binding ShowUomLabel}" />
                                    <Label Grid.Column="1"
                                           Text="{Binding OnHandText}"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource PrimaryDark}"
                                           HorizontalOptions="End" />
                                </Grid>
                                
                                    <!-- Product Details (Left) -->
                                <VerticalStackLayout Grid.Column="0" Grid.Row="2" Spacing="1">
                                    <Label Text="{Binding ListPriceText}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding TypeText}"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           TextColor="{Binding ProductNameColor}"
                                           IsVisible="{Binding ShowTypeText}" />
                                    <Label Text="{Binding OrgQtyText}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           IsVisible="{Binding ShowOrgQty}" />
                                    <Label Text="{Binding LastVisitText}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           IsVisible="{Binding ShowLastVisit}" />
                                    <Label Text="{Binding PerWeekText}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           IsVisible="{Binding ShowPerWeek}" />
                                </VerticalStackLayout>
                                
                                <!-- Price and Add Button (Right) -->
                                <VerticalStackLayout Grid.Column="1" Grid.Row="3" Spacing="2" HorizontalOptions="End">
                                    <Label Text="{Binding PriceText}"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray900}"
                                           HorizontalOptions="End" />
                                    <Label Text="{Binding TotalText}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}"
                                           HorizontalOptions="End" />
                                    <Button Text="{Binding QuantityButtonText}"
                                            Style="{StaticResource PrimaryButton}"
                                            Command="{Binding AddProductCommand}"
                                            CommandParameter="{Binding .}"
                                            IsEnabled="{Binding IsEnabled}"
                                            WidthRequest="70"
                                            HeightRequest="36"
                                            FontSize="18"
                                            FontAttributes="Bold"
                                            CornerRadius="4"
                                            HorizontalOptions="End"
                                            Margin="0,2,0,0">
                                        <Button.Triggers>
                                            <DataTrigger TargetType="Button" Binding="{Binding HasZeroWeightLine}" Value="True">
                                                <Setter Property="Style" Value="{StaticResource DeleteButton}" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>
                                </VerticalStackLayout>

                                <!-- Suggested Products Label (Green, at bottom) -->
                                <Label Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="4"
                                       Text="{Binding SuggestedLabelText}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource colorLaceupGreen}"
                                       IsVisible="{Binding IsSuggested}"
                                       Margin="0,4,0,0" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <Label Text="No previously ordered products found."
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,50,0,0" />
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>
    </ContentPage.Content>
</local:LaceupContentPage>


<?xml version="1.0" encoding="utf-8" ?>
<local:LaceupContentPage
    xmlns:local="clr-namespace:LaceupMigration.Views"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:LaceupMigration.ViewModels"
    x:Class="LaceupMigration.Views.OrderCreditPage"
    x:DataType="vm:OrderCreditPageViewModel"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False"
    Title="Add Credit Items">
    
    <ContentPage.Content>
        <Grid RowDefinitions="Auto,Auto,Auto,*">
            <!-- Action Buttons -->
            <Grid Grid.Row="0" ColumnDefinitions="*,*,*,*" ColumnSpacing="4" Padding="8,8,8,4">
                <Button Text="Prod"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding AddProductCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="0" />
                <Button Text="Cats"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding ViewCategoriesCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="1" />
                <Button Text="Search"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SearchCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="2" />
                <Button Text="{Binding DoneButtonText}"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding DoneCommand}"
                        IsEnabled="{Binding CanEdit}"
                        Grid.Column="3" />
            </Grid>

            <!-- Customer and Order Summary (Collapsible, expanded by default) -->
            <Frame Grid.Row="1" Padding="5" Margin="8,2" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}">
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="6" RowSpacing="4">
                    <!-- Collapsed View: Client Name and Total -->
                    <Label Grid.Row="0" Grid.Column="0"
                           Text="{Binding ClientName}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{StaticResource PrimaryDark}"
                           VerticalOptions="Center"
                           LineBreakMode="TailTruncation" />
                    <Label Grid.Row="0" Grid.Column="1"
                           Text="{Binding TotalText}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{StaticResource PrimaryDark}"
                           HorizontalOptions="End"
                           VerticalOptions="Center"
                           IsVisible="{Binding ShowTotalInHeader}" />
                    <!-- Expand/Collapse Indicator -->
                    <Grid Grid.Row="0" Grid.Column="2"
                          HorizontalOptions="End"
                          VerticalOptions="Center"
                          WidthRequest="24"
                          HeightRequest="24">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleOrderSummaryCommand}" />
                        </Grid.GestureRecognizers>
                        <Label Text="{Binding IsOrderSummaryExpanded, Converter={StaticResource ExpandIconConverter}}"
                               FontSize="14"
                               TextColor="{StaticResource Gray600}"
                               VerticalOptions="Center"
                               HorizontalOptions="Center" />
                    </Grid>
                    <!-- Expanded Content -->
                    <Grid Grid.Row="1" Grid.ColumnSpan="3"
                          RowDefinitions="Auto,Auto,Auto"
                          ColumnDefinitions="*,*,*"
                          ColumnSpacing="3"
                          RowSpacing="4"
                          Margin="0,4,0,0"
                          IsVisible="{Binding IsOrderSummaryExpanded}">
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Grid.ColumnSpan="3">
                            <Label Grid.Column="0"
                                   Text="{Binding CompanyText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray600}"
                                   IsVisible="{Binding ShowCompany}"
                                   Margin="0,0,0,0" />
                            <Label Grid.Column="1"
                                   Text="{Binding TermsText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   IsVisible="{Binding TermsVisible}"
                                   TextColor="{StaticResource Gray600}"
                                   Margin="0,0,0,0" />
                        </Grid>
                        <!-- Order Metrics (Left Column) -->
                        <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="2">
                            <Label Text="{Binding LinesText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}" />
                            <Label Text="{Binding QtySoldText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}" />
                        </VerticalStackLayout>
                        <!-- Order Financials (Middle Column) -->
                        <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="2">
                            <Label Text="{Binding OrderAmountText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   IsVisible="{Binding ShowOrderAmountInTotals}" />
                            <Label Text="{Binding CreditAmountText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   IsVisible="{Binding ShowTotals}" />
                            <Label Text="{Binding SubtotalText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   IsVisible="{Binding ShowTotals}" />
                        </VerticalStackLayout>
                        <!-- Order Financials (Right Column) -->
                        <VerticalStackLayout Grid.Row="1" Grid.Column="2" Spacing="2">
                            <Label Text="{Binding TaxText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   IsVisible="{Binding ShowTotals}" />
                            <Label Text="{Binding DiscountText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   IsVisible="{Binding ShowDiscount}" />
                            <Label Text="{Binding TotalText}"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryDark}"
                                   IsVisible="{Binding ShowTotals}" />
                        </VerticalStackLayout>
                    </Grid>
                </Grid>
            </Frame>

            <!-- Sort By -->
            <Grid Grid.Row="2" Padding="8,4,16,4">
                <Label Text="{Binding SortByText}"
                       FontSize="14"
                       TextColor="{StaticResource PrimaryDark}"
                       HorizontalOptions="End"
                       VerticalOptions="Center">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortByCommand}" />
                    </Label.GestureRecognizers>
                </Label>
            </Grid>

            <!-- Credit Items List -->
            <CollectionView Grid.Row="3"
                            ItemsSource="{Binding LineItems}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:OrderCreditLineItemViewModel">
                        <Frame Padding="12" Margin="8,4" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}">
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="4">
                                <!-- Product Name and OH -->
                                <Label Grid.Column="0" Grid.Row="0"
                                       Text="{Binding ProductName}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{Binding TypeColor}" />
                                <Label Grid.Column="1" Grid.Row="0"
                                       Text="{Binding OnHandText}"
                                       FontSize="14"
                                       TextColor="{Binding OnHandColor}"
                                       HorizontalOptions="End" />
                                
                                <!-- Product Details (Left) -->
                                <VerticalStackLayout Grid.Column="0" Grid.Row="1" Spacing="2">
                                    <Label Text="{Binding ListPriceText}"
                                           FontSize="13"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding UomText}"
                                           FontSize="13"
                                           TextColor="{StaticResource Gray600}"
                                           IsVisible="{Binding UomText, Converter={StaticResource IsStringNotEmptyConverter}}" />
                                    <Label Text="{Binding TypeText}"
                                           IsVisible="{Binding ShowType}"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           TextColor="{Binding TypeColor}"
                                           TextDecorations="Underline" />
                                    <Label Text="{Binding PriceText}"
                                           FontSize="13"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding TotalText}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource PrimaryDark}" />
                                </VerticalStackLayout>
                                
                                <!-- Quantity Button (Right) -->
                                <Button Grid.Column="1" Grid.Row="1"
                                        Style="{StaticResource PrimaryButton}"
                                        Text="{Binding QuantityButtonText}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OrderCreditPageViewModel}}, Path=EditLineItemCommand}"
                                        CommandParameter="{Binding .}"
                                        IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:OrderCreditPageViewModel}}, Path=CanEdit}"
                                        WidthRequest="50"
                                        HeightRequest="50"
                                        FontSize="18"
                                        FontAttributes="Bold"
                                        CornerRadius="4"
                                        VerticalOptions="Start"
                                        HorizontalOptions="End" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <Label Text="No credit items added yet."
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,50,0,0" />
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>
    </ContentPage.Content>
</local:LaceupContentPage >

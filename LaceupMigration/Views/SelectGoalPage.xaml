<?xml version="1.0" encoding="utf-8" ?>
<local:LaceupContentPage xmlns:local="clr-namespace:LaceupMigration.Views" xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaceupMigration.ViewModels"
             xmlns:icons="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="LaceupMigration.Views.SelectGoalPage"
             Shell.TabBarIsVisible="False"
             Title="Goals">
    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Search Bar at the top (matching Xamarin layout) -->
        <Border Grid.Row="0"
                Margin="8,8,8,0"
                StrokeThickness="1"
                BackgroundColor="White"
                Padding="12,2"
                StrokeShape="RoundRectangle 12">
            <SearchBar Text="{Binding SearchText}"
                       BackgroundColor="Transparent"
                       TextChanged="OnSearchTextChanged" />
        </Border>
        
        <StackLayout Grid.Row="1" Orientation="Horizontal"  HorizontalOptions="FillAndExpand" >
            <Grid ColumnDefinitions="auto,*,auto" HorizontalOptions="FillAndExpand" Margin="20,5,5,0" >
                <Label Grid.Column="0" Text="Goals" FontSize="18" VerticalOptions="Center" FontAttributes="Bold" TextColor="{StaticResource colorLaceupDark}"></Label>

                <Button Grid.Column="2" 
                        BackgroundColor="Transparent" 
                        ImageSource="{icons:MaterialOutlined Icon=Menu, IconColor={StaticResource colorLaceupDark}}"
                        Command="{Binding ShowFilterMenuCommand}" />  
            </Grid>
        </StackLayout>

        <ActivityIndicator Grid.Row="2"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="{StaticResource Primary}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />

        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding FilteredGoals}"
                        Margin="10,2,10,10">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:GoalItemViewModel">
                    <Border Margin="0,20,0,10"
                            Padding="0"
                            BackgroundColor="Transparent"
                            Stroke="{StaticResource colorLaceupDark}"
                            StrokeThickness="2"
                            InputTransparent="False">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectGoalCommand}" 
                                                  CommandParameter="{Binding}" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout Spacing="0" InputTransparent="False">
                            <!-- Header Section (matching Xamarin cellHeader) -->
                            <Grid ColumnDefinitions="*,*"
                                  BackgroundColor="{StaticResource colorLaceupLightBlue}"
                                  Padding="3,3,2,3"
                                  Margin="3,3,2,0">
                                <Label Grid.Column="0"
                                       Text="{Binding Name, StringFormat='  {0}'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="Black"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       Text="{Binding CriteriaText, StringFormat='Type: {0}'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="Black"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Margin="0,0,5,0" />
                            </Grid>
                            
                            <!-- Main Content Section -->
                            <Grid ColumnDefinitions="0.4*,0.6*"
                                  Padding="5"
                                  Margin="5">
                                <!-- Left Side: Dates -->
                                <VerticalStackLayout Grid.Column="0"
                                                     Spacing="0"
                                                     Margin="5,0,0,0">
                                    <Label Text="{Binding StartDateText}"
                                           FontSize="12"
                                           TextColor="Black" />
                                    <Label Text="{Binding DaysToCompleteText}"
                                           FontSize="10"
                                           TextColor="Black"
                                           Margin="0,0,0,0" />
                                    <Label Text="{Binding EndDateText}"
                                           FontSize="12"
                                           TextColor="Black" />
                                </VerticalStackLayout>
                                
                                <!-- Right Side: Progress -->
                                <VerticalStackLayout Grid.Column="1"
                                                     Spacing="0"
                                                     Margin="5,0,5,0">
                                    <!-- Percentage Row -->
                                    <Grid ColumnDefinitions="0.7*,0.2*"
                                          Margin="0,0,5,0">
                                        <Label Grid.Column="0"
                                               Text="Real Accomplished"
                                               FontSize="10"
                                               TextColor="Black"
                                               VerticalOptions="Center" />
                                        <Label Grid.Column="1"
                                               Text="{Binding PercentageText}"
                                               FontSize="10"
                                               FontAttributes="Bold"
                                               TextColor="Black"
                                               HorizontalOptions="End"
                                               VerticalOptions="Center" />
                                    </Grid>
                                    
                                    <!-- Progress Bar -->
                                    <ProgressBar Progress="{Binding ProgressValue}"
                                                 ProgressColor="{Binding ProgressColor}"
                                                 Style="{x:Null}"
                                                 Margin="0,0,5,0"
                                                 HeightRequest="8"
                                                 VerticalOptions="Center" />
                                    
                                    <!-- Pending Days -->
                                    <Label Text="{Binding PendingDaysText}"
                                           FontSize="12"
                                           TextColor="{StaticResource colorLaceupRed}"
                                           HorizontalOptions="End"
                                           Margin="0,0,5,0" />
                                </VerticalStackLayout>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Filter Popup Overlay -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding IsFilterPopupVisible}"
              BackgroundColor="#80000000"
              InputTransparent="False"
              ColumnDefinitions="0.1*,0.8*,0.1*"
              RowDefinitions="0.1*,0.8*,0.1*">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseFilterPopupCommand}" />
            </Grid.GestureRecognizers>
            
            <Frame Grid.Row="1"
                   Grid.Column="1"
                   VerticalOptions="Fill"
                   HorizontalOptions="Fill"
                   Padding="0"
                   Margin="0"
                   BackgroundColor="White"
                   CornerRadius="8"
                   HasShadow="True"
                   InputTransparent="False">
                <ScrollView>
                    <VerticalStackLayout Padding="15" Spacing="0">
                        <!-- Filter By Goal Type -->
                        <Label Text="Filter By Goal Type:" 
                               FontSize="16" 
                               FontAttributes="Bold" 
                               Margin="5" />
                        
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterAll}"
                                      VerticalOptions="Center" />
                            <Label Text="All"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterRoute}"
                                      VerticalOptions="Center" />
                            <Label Text="Route"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterProduct}"
                                      VerticalOptions="Center" />
                            <Label Text="Product"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterPayment}"
                                      VerticalOptions="Center" />
                            <Label Text="Payment"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterCustomer}"
                                      VerticalOptions="Center" />
                            <Label Text="Customer"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding FilterProductByCustomer}"
                                      VerticalOptions="Center" />
                            <Label Text="Product By Customer"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <!-- Filter By Date -->
                        <Label Text="Filter By Date:" 
                               FontSize="16" 
                               FontAttributes="Bold" 
                               Margin="5,15,5,10" />
                        
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" RowSpacing="10">
                            <Label Grid.Row="0" Grid.Column="0" 
                                   Text="Start Date:" 
                                   VerticalOptions="Center" 
                                   Margin="5,0" />
                            <Button Grid.Row="0" Grid.Column="1" 
                                    Text="{Binding StartDateButtonText}"
                                    TextColor="{Binding StartDateButtonTextColor}"
                                    FontAttributes="{Binding StartDateButtonFontAttributes}"
                                    Command="{Binding SelectStartDateCommand}" />
                            
                            <Label Grid.Row="1" Grid.Column="0" 
                                   Text="End Date:" 
                                   VerticalOptions="Center" 
                                   Margin="5,0" />
                            <Button Grid.Row="1" Grid.Column="1" 
                                    Text="{Binding EndDateButtonText}"
                                    TextColor="{Binding EndDateButtonTextColor}"
                                    FontAttributes="{Binding EndDateButtonFontAttributes}"
                                    Command="{Binding SelectEndDateCommand}" />
                        </Grid>

                        <!-- Show Expired -->
                        <HorizontalStackLayout Spacing="8">
                            <CheckBox IsChecked="{Binding ShowExpired}"
                                      VerticalOptions="Center" />
                            <Label Text="Show Expired"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <!-- Remove Filters Button -->
                        <Button Text="Remove Filters" 
                                BackgroundColor="{StaticResource colorLaceupRed}"
                                TextColor="White"
                                Command="{Binding RemoveFiltersCommand}"
                                Margin="20,5" />

                        <!-- Action Buttons -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                            <Button Grid.Column="0" 
                                    Text="Cancel" 
                                    Command="{Binding CloseFilterPopupCommand}" />
                            <Button Grid.Column="1" 
                                    Text="Apply" 
                                    Command="{Binding ApplyFiltersCommand}" />
                        </Grid>
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>
        </Grid>
    </Grid>
</local:LaceupContentPage>

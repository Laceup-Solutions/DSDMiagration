<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaceupMigration.ViewModels"
             x:Class="LaceupMigration.Views.FullCategoryPage"
             x:DataType="vm:FullCategoryPageViewModel"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             Shell.NavBarIsVisible="True"
             Shell.TabBarIsVisible="False"
             Title="{Binding Title}">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Menu" Order="Primary" Priority="0" IconImageSource="{mi:MaterialOutlined Icon=Menu, IconColor=Black}"/>
    </ContentPage.ToolbarItems>
    <ContentPage.Content>
        <Grid RowDefinitions="Auto,Auto,*" Padding="5">
            <!-- Search Bar with Barcode Icon (matches Xamarin layout) -->
            <Frame Grid.Row="0" Margin="5,10,5,0" Padding="0" HasShadow="False" BorderColor="{StaticResource Gray300}" BackgroundColor="{StaticResource White}">
                <Grid ColumnDefinitions="*,Auto" Padding="8,0">
                    <SearchBar Grid.Column="0"
                               Text="{Binding SearchQuery}"
                               Placeholder="Search categories or products..."
                               SearchButtonPressed="SearchBar_SearchButtonPressed"
                               BackgroundColor="Transparent"
                               Margin="0" />
                    <ImageButton Grid.Column="1"
                                 Source="{mi:MaterialOutlined Icon=QrCode, IconColor=Black}"
                                 WidthRequest="40"
                                 HeightRequest="40"
                                 BackgroundColor="Transparent"
                                 Command="{Binding ScanCommand}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center" />
                </Grid>
            </Frame>

            <!-- Radio Buttons (horizontal) - Only show when displaying categories (matches FullCategoryActivity) -->
            <HorizontalStackLayout Grid.Row="1" 
                                   Spacing="16" 
                                   HorizontalOptions="Center" 
                                   Margin="0,8,0,0"
                                   IsVisible="{Binding ShowCategories}">
                <RadioButton Content="By Category"
                             IsChecked="{Binding SearchByCategory}"
                             GroupName="SearchType" />
                <RadioButton Content="By Product"
                             IsChecked="{Binding SearchByProduct}"
                             GroupName="SearchType" />
            </HorizontalStackLayout>

            <!-- Categories ListView (matches Xamarin layout - fills remaining space) -->
            <CollectionView x:Name="CategoriesCollectionView"
                            Grid.Row="2"
                            ItemsSource="{Binding Categories}"
                            SelectionMode="None"
                            Margin="0,20,0,0"
                            IsVisible="{Binding ShowCategories}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:CategoryViewModel">
                        <Frame Padding="0" Margin="8,4" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}" BorderColor="{StaticResource Gray200}">
                            <Grid RowDefinitions="Auto,Auto" Padding="12">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="Category_Tapped" />
                                </Grid.GestureRecognizers>
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding Name}"
                                           FontSize="16"
                                           TextColor="{StaticResource Gray900}"
                                           VerticalOptions="Center" />
                                    <Image Grid.Column="1"
                                           Source="{mi:MaterialOutlined Icon=ExpandMore, IconColor=Gray}"
                                           WidthRequest="24"
                                           HeightRequest="24"
                                           IsVisible="{Binding ShowSubcategories}"
                                           VerticalOptions="Center" />
                                </Grid>
                                <!-- Subcategories (expandable) -->
                                <VerticalStackLayout Grid.Row="1" 
                                                     IsVisible="{Binding IsExpanded}"
                                                     Margin="20,0,0,0"
                                                     Spacing="4">
                                    <CollectionView ItemsSource="{Binding Subcategories}"
                                                    SelectionMode="Single"
                                                    SelectionChanged="Subcategory_SelectionChanged">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Frame Padding="8" Margin="0,2" HasShadow="False" CornerRadius="4" BackgroundColor="{StaticResource Gray100}" BorderColor="{StaticResource Gray300}">
                                                    <Frame.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="Subcategory_Tapped" />
                                                    </Frame.GestureRecognizers>
                                                    <Label Text="{Binding Name}"
                                                           FontSize="14"
                                                           TextColor="{StaticResource Gray900}"
                                                           VerticalOptions="Center" />
                                                </Frame>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Products ListView (matches Xamarin layout - fills remaining space) -->
            <CollectionView x:Name="ProductsCollectionView"
                            Grid.Row="2"
                            ItemsSource="{Binding Products}"
                            SelectionMode="Single"
                            Margin="0,20,0,0"
                            IsVisible="{Binding ShowProducts}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:ProductViewModel">
                        <Grid Style="{StaticResource CollectionViewItemStyle}">
                            <Frame Padding="0" Margin="8,4" HasShadow="False" CornerRadius="8" BackgroundColor="{StaticResource White}" BorderColor="{StaticResource Gray200}">
                                <Grid Padding="12">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="ProductCell_Tapped" />
                                </Grid.GestureRecognizers>
                                <VerticalStackLayout Spacing="8">
                                <!-- Product Image (centered at top, matches Xamarin's full width with minHeight 300dp) -->
                                <Image Source="{Binding ProductImagePath}"
                                       HeightRequest="300"
                                       MinimumHeightRequest="300"
                                       Aspect="AspectFit"
                                       HorizontalOptions="Fill"
                                       VerticalOptions="Start"
                                       Margin="0,20,0,20"
                                       IsVisible="{Binding HasImage}">
                                    <Image.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="ProductImage_Tapped" />
                                    </Image.GestureRecognizers>
                                </Image>
                                
                                <!-- Product Name -->
                                <Label Text="{Binding Name}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}"
                                       HorizontalOptions="Start"
                                       Margin="0,4,0,0" />
                                
                                <!-- All details in a column -->
                                <!-- All details in a 2-column grid -->
                                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="16" RowSpacing="4">
                                    <!-- UPC (left, row 0) -->
                                    <Label Grid.Column="0" Grid.Row="0"
                                           Text="{Binding Upc, StringFormat='UPC: {0}'}"
                                           FontSize="13"
                                           TextColor="{StaticResource colorLaceupDark}"
                                           HorizontalOptions="Start" />
    
                                    <!-- Packaging (right, row 0) -->
                                    <Label Grid.Column="1" Grid.Row="0"
                                           Text="{Binding Packaging, StringFormat='Packaging: {0}'}"
                                           FontSize="13"
                                           TextColor="{StaticResource colorLaceupDark}"
                                           HorizontalOptions="Start" />
    
                                    <!-- Price (left, row 1) -->
                                    <Label Grid.Column="0" Grid.Row="1"
                                           Text="{Binding Price, StringFormat='Price: {0}'}"
                                           FontSize="13"
                                           TextColor="{StaticResource colorLaceupDark}"
                                           IsVisible="{Binding ShowPrice}"
                                           HorizontalOptions="Start" />
    
                                    <!-- OH (On Hand) (right, row 1) -->
                                    <Label Grid.Column="1" Grid.Row="1"
                                           Text="{Binding OnHandText, StringFormat='OH: {0}'}"
                                           FontSize="13"
                                           TextColor="{StaticResource colorLaceupDark}"
                                           HorizontalOptions="Start" />
    
                                    <!-- UoM (Primary) - if single UoM (left, row 2) -->
                                    <Label Grid.Column="0" Grid.Row="2"
                                           Text="{Binding Uom, StringFormat='UoM: {0}'}"
                                           FontSize="13"
                                           TextColor="{StaticResource colorLaceupDark}"
                                           IsVisible="{Binding ShowUom}"
                                           HorizontalOptions="Start" />
    
                                    <!-- Secondary UoM details (if multiple UoMs) (spans both columns, row 3) -->
                                    <VerticalStackLayout Grid.Column="0" Grid.Row="3" Grid.ColumnSpan="2" 
                                                         Spacing="4" IsVisible="{Binding ShowUom1}" Margin="0,4,0,0">
                                        <Label Text="{Binding Price1, StringFormat='Price: {0}'}"
                                               FontSize="13"
                                               TextColor="{StaticResource colorLaceupDark}"
                                               IsVisible="{Binding ShowPrice1}"
                                               HorizontalOptions="Start" />
                                        <Label Text="{Binding OnHand1, StringFormat='OH: {0}'}"
                                               FontSize="13"
                                               TextColor="{StaticResource colorLaceupDark}"
                                               IsVisible="{Binding ShowOnHand1}"
                                               HorizontalOptions="Start" />
                                        <Label Text="{Binding Uom1, StringFormat='UoM: {0}'}"
                                               FontSize="13"
                                               TextColor="{StaticResource colorLaceupDark}"
                                               IsVisible="{Binding ShowUom1}"
                                               HorizontalOptions="Start" />
                                    </VerticalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Grid.Row="2"
                   Text="No items found."
                   IsVisible="{Binding ShowNoCategories}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Margin="0,20,0,20"
                   TextColor="{StaticResource Gray500}" />
        </Grid>
    </ContentPage.Content>
</ContentPage>